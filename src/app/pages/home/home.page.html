<ion-header class="ion-no-border">
  <ion-toolbar
    style="--background: transparent; --ion-background-color: transparent"
  >
    <ion-searchbar
      [(ngModel)]="citySearch"
      (search)="searchCity()"
      (ionInput)="onSearchInput($event)"
      [placeholder]="'HOME.SEARCH_PLACEHOLDER' | translate"
      class="custom-searchbar"
    ></ion-searchbar>

    <ion-buttons slot="end">
      <!-- Custom Language Toggle -->
      <div class="language-toggle">
        <div
          class="toggle-option"
          [class.active]="currentLang === 'en'"
          (click)="currentLang !== 'en' && toggleLanguage()"
        >
          EN
        </div>
        <div
          class="toggle-option"
          [class.active]="currentLang === 'es'"
          (click)="currentLang !== 'es' && toggleLanguage()"
        >
          ES
        </div>
      </div>

      <!-- Location Button -->
      <ion-button
        fill="clear"
        (click)="getCurrentLocation()"
        [disabled]="loadingLocation"
        class="location-button"
      >
        <ion-icon
          slot="icon-only"
          name="locate"
          style="color: white !important"
          *ngIf="!loadingLocation"
        ></ion-icon>
        <ion-spinner name="crescent" *ngIf="loadingLocation"></ion-spinner>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Suggestions Dropdown (Floating) -->
  @if (showSuggestions && citySuggestions.length > 0) {
  <div class="suggestions-container">
    <ion-list lines="none" class="glass-list">
      @for (city of citySuggestions; track city.lat) {
      <ion-item button (click)="selectCity(city)" detail="false">
        <ion-label>
          <h3>{{ city.name }}</h3>
          <p>{{ city.state ? city.state + ', ' : '' }}{{ city.country }}</p>
        </ion-label>
      </ion-item>
      }
    </ion-list>
  </div>
  } @if (weatherData) {
  <div class="main-container ion-padding">
    <ion-grid>
      <ion-row class="desktop-split">
        <!-- LEFT COLUMN: Hero & Current Details (Center/Left on Desktop) -->
        <ion-col size-xs="12" size-md="5" size-lg="5" class="left-col">
          <!-- HERO SECTION -->
          <div class="hero-section ion-text-center">
            <h2 class="city-name">
              {{ weatherData.current.name || (citySearch | uppercase) }}
            </h2>
            <div class="temperature-container">
              <h1 class="main-temp">
                {{ weatherData.current.temp | number:'1.0-0' }}°
              </h1>
            </div>

            <div class="condition-container">
              <app-weather-icon
                [iconCode]="weatherData.current.weather[0].icon"
                style="font-size: 24px"
              ></app-weather-icon>
              <span class="condition-text"
                >{{ weatherData.current.weather[0].description | titlecase
                }}</span
              >
            </div>

            <div class="high-low">
              H: {{ weatherData.daily[0].temp.max | number:'1.0-0' }}° | L: {{
              weatherData.daily[0].temp.min | number:'1.0-0' }}°
            </div>
          </div>

          <!-- DETAILS GRID -->
          <ion-grid class="ion-no-padding ion-margin-top api-details">
            <ion-row>
              <ion-col size="6" class="ion-padding-end">
                <div class="glass-card detail-card">
                  <div class="card-header">
                    <ion-icon name="sunny" color="warning"></ion-icon>
                    <span>{{ 'WEATHER.UV' | translate }}</span>
                  </div>
                  <div class="card-value">
                    {{ weatherData.current.uvi ? weatherData.current.uvi : '' }}
                    <span
                      class="badge"
                      [ngClass]="{'high': weatherData.current.uvi > 5, 'low': weatherData.current.uvi <= 5}"
                      *ngIf="weatherData.current.uvi"
                    >
                      {{ (weatherData.current.uvi > 5 ? 'WEATHER.HIGH' :
                      'WEATHER.LOW') | translate }}
                    </span>
                    <span class="badge low" *ngIf="!weatherData.current.uvi"
                      >N/A</span
                    >
                  </div>
                  <ion-progress-bar
                    [value]="weatherData.current.uvi / 11"
                    color="warning"
                  ></ion-progress-bar>
                </div>
              </ion-col>
              <ion-col size="6" class="ion-padding-start">
                <div class="glass-card detail-card">
                  <div class="card-header">
                    <ion-icon name="navigate" color="tertiary"></ion-icon>
                    <span>{{ 'WEATHER.WIND' | translate }}</span>
                  </div>
                  <div class="wind-circle">
                    <div
                      class="arrow"
                      [style.transform]="'rotate(' + (weatherData.current.wind_deg || 0) + 'deg)'"
                    >
                      ➤
                    </div>
                    <div class="speed" style="color: white">
                      {{ weatherData.current.wind_speed | number:'1.0-0' }}
                      <span class="unit">
                        {{ (currentUnit === 'imperial' ? 'WEATHER.MPH' :
                        'WEATHER.KPH') | translate }}
                      </span>

                      <!-- Wind Level Badge -->
                      <span
                        class="badge"
                        [class.low]="getWindStatus(weatherData.current.wind_speed).color === 'success'"
                        [class.high]="getWindStatus(weatherData.current.wind_speed).color !== 'success'"
                        style="
                          margin-left: 8px;
                          font-size: 0.7rem;
                          vertical-align: middle;
                        "
                      >
                        {{ getWindStatus(weatherData.current.wind_speed).key |
                        translate }}
                      </span>
                    </div>

                    <!-- Direction text could be complex to translate dynamically without logic, simplifying for now or kept static -->
                  </div>
                  <ion-progress-bar
                    [value]="getWindStatus(weatherData.current.wind_speed).value"
                    [color]="getWindStatus(weatherData.current.wind_speed).color"
                  ></ion-progress-bar>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-col>

        <!-- RIGHT COLUMN: Timeline & Forecast (Right on Desktop) -->
        <ion-col
          size-xs="12"
          size-md="7"
          size-lg="6"
          offset-lg="1"
          class="right-col"
        >
          <!-- SECTIONS -->
          <div class="section-title">
            <span>{{ 'HOME.TIMELINE' | translate }}</span>
          </div>

          <!-- HOURLY -->
          <app-hourly-breakdown
            [hourlyForecast]="weatherData.hourly | slice:0:12"
          ></app-hourly-breakdown>

          <div class="section-title ion-margin-top">
            <span>{{ 'HOME.FORECAST_TITLE' | translate }}</span>
          </div>

          <app-forecast-list
            [dailyForecast]="weatherData.daily | slice:0:5"
          ></app-forecast-list>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
  } @else {
  <div
    class="ion-text-center ion-padding"
    style="margin-top: 50vh; transform: translateY(-50%)"
  >
    <p style="color: white">{{ 'HOME.LOADING' | translate }}</p>
    <ion-spinner color="light"></ion-spinner>
  </div>
  }
</ion-content>
